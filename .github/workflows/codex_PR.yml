name: AI-powered pull request review
on:
  pull_request:   
    types: [opened, synchronize, reopened]
  workflow_dispatch:  
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: number
      base_branch:
        description: 'Base branch to compare against'
        required: false
        type: string
        default: 'main'
      debug_mode:
        description:  'Enable debug output'
        required: false
        type: boolean
        default: false

jobs:  
  ai_review:
    runs-on:  ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Set PR context
        id: set_pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "pr_number=${{ inputs.pr_number || '' }}" >> $GITHUB_OUTPUT
            echo "base_branch=${{ inputs.base_branch || 'main' }}" >> $GITHUB_OUTPUT
            echo "is_manual=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "base_branch=${{ github.event.pull_request.base.ref }}" >> $GITHUB_OUTPUT
            echo "is_manual=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.pr_number != '' && format('refs/pull/{0}/head', inputs.pr_number) || '' }}

      - name: Get PR diff
        id: get_diff
        run:  |
          BASE_BRANCH="${{ steps.set_pr.outputs.base_branch }}"
          
          echo "Fetching base branch:  $BASE_BRANCH"
          git fetch origin "$BASE_BRANCH"
          
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Current branch: $CURRENT_BRANCH"
          
          # ÁîüÊàê diff
          if git diff "origin/$BASE_BRANCH... HEAD" > pr-diff.txt 2>&1; then
            echo "‚úì Diff generated successfully"
          else
            echo "‚ö†Ô∏è Three-dot diff failed, trying two-dot syntax..."
            if git diff "origin/$BASE_BRANCH.. HEAD" > pr-diff.txt 2>&1; then
              echo "‚úì Diff generated with two-dot syntax"
            else
              echo "‚ö†Ô∏è Two-dot diff failed, trying simple diff..."
              git diff "origin/$BASE_BRANCH" HEAD > pr-diff.txt 2>&1 || {
                echo "‚ùå All diff methods failed"
                exit 1
              }
            fi
          fi
          
          DIFF_SIZE=$(wc -c < pr-diff.txt)
          echo "Diff size: $DIFF_SIZE bytes"
          
          if [ "$DIFF_SIZE" -eq 0 ] || [ !  -s pr-diff.txt ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úì Changes detected ($DIFF_SIZE bytes)"
          fi

      - name: Debug - Show diff preview
        if: inputs.debug_mode == true || inputs.debug_mode == 'true'
        run: |
          echo "=== First 50 lines of diff ==="
          head -n 50 pr-diff.txt 2>/dev/null || echo "Cannot read pr-diff.txt"

      - name: Read review prompt
        id: read_prompt
        run:  |
          if [ -f . github/codex/prompts/review. md ]; then
            echo "‚úì Using custom review prompt"
            cat .github/codex/prompts/review.md > prompt.txt
          else
            echo "‚ö†Ô∏è Using default review prompt"
            echo "You are a code review assistant.  Analyze the following code changes and identify syntax errors, potential bugs, and suggest improvements." > prompt.txt
          fi

      - name: Prepare review request
        if: steps.get_diff.outputs.has_changes == 'true'
        run: |
          # ËØªÂèñ prompt
          PROMPT=$(cat prompt.txt)
          
          # ËØªÂèñ diffÔºàÈôêÂà∂Âà∞ 10000 Â≠óÁ¨¶‰ª•ÈÅøÂÖç token Ë∂ÖÈôêÔºâ
          DIFF=$(head -c 10000 pr-diff. txt)
          
          # ‰ΩøÁî® jq ÊûÑÂª∫ÂÆåÊï¥ÁöÑ JSONÔºàËøôÊ†∑ÂèØ‰ª•Ê≠£Á°ÆÂ§ÑÁêÜÁâπÊÆäÂ≠óÁ¨¶Ôºâ
          jq -n \
            --arg model "gpt-4" \
            --arg system_prompt "$PROMPT" \
            --arg user_message "Please review the following code changes and identify syntax errors, potential bugs, and improvement suggestions:\n\n$DIFF" \
            '{
              model: $model,
              messages: [
                {
                  role: "system",
                  content: $system_prompt
                },
                {
                  role: "user",
                  content: $user_message
                }
              ],
              temperature: 0.3,
              max_tokens: 2000
            }' > request.json
          
          echo "‚úì Request JSON created"
          
          # È™åËØÅ JSON Ê†ºÂºè
          if jq empty request.json 2>/dev/null; then
            echo "‚úì JSON is valid"
          else
            echo "‚ùå Invalid JSON"
            cat request.json
            exit 1
          fi

      - name:  Debug - Show request
        if: inputs.debug_mode == true || inputs.debug_mode == 'true'
        run: |
          echo "=== Request JSON (pretty printed) ==="
          jq .  request.json

      - name: Call OpenAI API
        if:  steps.get_diff.outputs. has_changes == 'true'
        id: ai_review
        env:
          OPENAI_API_KEY: ${{ secrets. OPENAI_API_KEY }}
        run: |
          # Ê£ÄÊü• API key
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY is not set"
            echo "Please add it to:  Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            exit 1
          fi
          
          echo "Calling OpenAI API..."
          
          # Ë∞ÉÁî® API
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d @request.json)
          
          # ÂàÜÁ¶ª body Âíå status code
          HTTP_BODY=$(echo "$HTTP_RESPONSE" | head -n -1)
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n 1)
          
          echo "$HTTP_BODY" > response.json
          echo "HTTP Status: $HTTP_CODE"
          
          # Ê£ÄÊü•Áä∂ÊÄÅÁ†Å
          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå API request failed with status $HTTP_CODE"
            echo "Response:"
            jq . response.json 2>/dev/null || cat response.json
            exit 1
          fi
          
          # Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ
          if jq -e '.error' response.json > /dev/null 2>&1; then
            echo "‚ùå OpenAI API Error:"
            jq -r '.error.message' response.json
            exit 1
          fi
          
          # ÊèêÂèñÂõûÂ§çÂÜÖÂÆπ
          if !  REVIEW_CONTENT=$(jq -r '.choices[0].message.content' response.json 2>/dev/null); then
            echo "‚ùå Failed to parse API response"
            echo "Response structure:"
            jq . response. json
            exit 1
          fi
          
          # Ê£ÄÊü•ÂÜÖÂÆπÊòØÂê¶‰∏∫Á©∫
          if [ -z "$REVIEW_CONTENT" ] || [ "$REVIEW_CONTENT" = "null" ]; then
            echo "‚ùå Empty review content received"
            jq . response.json
            exit 1
          fi
          
          # ‰øùÂ≠òÂà∞Êñá‰ª∂
          echo "$REVIEW_CONTENT" > ai-review-output.md
          
          # ‰øùÂ≠òÂà∞ËæìÂá∫
          {
            echo "review_content<<EOFMARKER"
            echo "$REVIEW_CONTENT"
            echo "EOFMARKER"
          } >> "$GITHUB_OUTPUT"
          
          echo "‚úì AI review completed successfully"
          echo ""
          echo "=== Review Preview ==="
          head -n 20 ai-review-output.md

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name:  ai-review-output-${{ steps.set_pr. outputs.pr_number || github.run_number }}
          path: |
            ai-review-output. md
            pr-diff.txt
            prompt.txt
            request.json
            response.json
          retention-days: 7
          if-no-files-found: warn

      - name: Post review as PR comment
        if: steps. ai_review.outputs.review_content != '' && steps.set_pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const fs = require('fs');
            
            // ËØªÂèñ review ÂÜÖÂÆπ
            let reviewContent;
            try {
              reviewContent = fs. readFileSync('ai-review-output.md', 'utf8');
            } catch (error) {
              console.error('Failed to read ai-review-output.md:', error);
              return;
            }
            
            const comment = `## ü§ñ AI Code Review
            
            ${reviewContent}
            
            ---
            <sub>Generated by AI ‚Ä¢ [View artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})</sub>`;
            
            try {
              await github.rest. issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ steps.set_pr.outputs.pr_number }},
                body: comment
              });
              console.log('‚úÖ Posted AI review to PR #${{ steps.set_pr.outputs.pr_number }}');
            } catch (error) {
              console.error('Failed to post comment:', error);
              throw error;
            }

      - name: Show review in console
        if: steps.ai_review.outputs.review_content != ''
        run: |
          echo "==============================================="
          echo "           ü§ñ AI CODE REVIEW RESULT"
          echo "==============================================="
          cat ai-review-output.md
          echo ""
          echo "==============================================="
