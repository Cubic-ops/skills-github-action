name: AI-powered pull request review
on:
  pull_request:  
    types: [opened, synchronize, reopened]
  workflow_dispatch: 
    inputs:
      pr_number:
        description: 'PR number to review'
        required: false
        type: number
      debug_mode:
        description: 'Enable debug output'
        required: false
        type: boolean
        default: false

jobs: 
  ai_review:
    runs-on:  ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Set PR context
        id: set_pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.pr_number }}" ]; then
            echo "pr_number=${{ inputs. pr_number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name:  Get PR diff
        id: get_diff
        run:  |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            git fetch origin ${{ github.event.pull_request.base.ref }}
            git diff origin/${{ github.event.pull_request.base.ref }}... HEAD > pr-diff.txt
          else
            git fetch origin main
            git diff origin/main... HEAD > pr-diff.txt
          fi
          
          # æ£€æŸ¥ diff æ˜¯å¦ä¸ºç©º
          if [ !  -s pr-diff.txt ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ“ Changes detected"
          fi

      - name: Debug - Show diff
        if: inputs.debug_mode == true
        run: |
          echo "=== PR Diff Preview ==="
          head -n 50 pr-diff.txt || echo "Empty diff"

      - name: Read review prompt
        id: read_prompt
        run: |
          if [ -f .github/codex/prompts/review.md ]; then
            PROMPT=$(cat .github/codex/prompts/review.md)
          else
            PROMPT="You are a code review assistant.  Analyze the following code changes and identify syntax errors, potential bugs, and suggest improvements."
          fi
          
          # è½¬ä¹‰å¹¶ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "REVIEW_PROMPT<<EOF" >> $GITHUB_ENV
          echo "$PROMPT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Call OpenAI API for review
        if: steps.get_diff.outputs.has_changes == 'true'
        id: ai_review
        env:
          OPENAI_API_KEY: ${{ secrets. OPENAI_API_KEY }}
        run: |
          # è¯»å– diff å†…å®¹
          DIFF_CONTENT=$(cat pr-diff.txt)
          
          # æ„å»ºè¯·æ±‚ä½“
          REQUEST_BODY=$(jq -n \
            --arg model "gpt-4" \
            --arg prompt "$REVIEW_PROMPT" \
            --arg diff "$DIFF_CONTENT" \
            '{
              model: $model,
              messages: [
                {
                  role: "system",
                  content: $prompt
                },
                {
                  role: "user",
                  content: ("Please review the following code changes:\n\n" + $diff)
                }
              ],
              temperature: 0.3,
              max_tokens: 2000
            }')
          
          # è°ƒç”¨ OpenAI API
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$REQUEST_BODY")
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
          if echo "$RESPONSE" | jq -e '. error' > /dev/null; then
            echo "âŒ OpenAI API Error:"
            echo "$RESPONSE" | jq -r '.error.message'
            exit 1
          fi
          
          # æå–å›å¤å†…å®¹
          REVIEW_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0]. message.content')
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$REVIEW_CONTENT" > ai-review-output.md
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "review_content<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ“ AI review completed"

      - name: Upload review output
        if: always() && steps.get_diff.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name:  ai-review-output-pr-${{ steps.set_pr.outputs.pr_number || 'manual' }}
          path: |
            ai-review-output. md
            pr-diff.txt
          retention-days: 7

      - name: Post review as PR comment
        if: steps.ai_review.outputs.review_content != '' && steps.set_pr.outputs.pr_number != ''
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const reviewContent = `## ğŸ¤– AI Code Review
            
            ${{ steps.ai_review.outputs.review_content }}
            
            ---
            *Generated by AI-powered code review*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.set_pr.outputs.pr_number }},
              body: reviewContent
            });
            
            console.log('âœ… Posted AI review to PR #${{ steps.set_pr.outputs.pr_number }}');
