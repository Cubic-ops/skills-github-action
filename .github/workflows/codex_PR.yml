name:  Codex pull request review
on:
  pull_request: 
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs: 
      pr_number:
        description: 'PR number to review'
        required: false
        type: number
      debug_mode:
        description: 'Enable debug output'
        required: false
        type: boolean
        default: false

jobs:
  codex: 
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    outputs:
      final_message: ${{ steps.run_codex.outputs.final-message }}
    steps:
      - name: Set PR context
        id: set_pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.pr_number }}" ]; then
            echo "pr_number=${{ inputs. pr_number }}" >> $GITHUB_OUTPUT
            # 使用 head 而不是 merge
            echo "ref=refs/pull/${{ inputs.pr_number }}/head" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr_number=${{ github.event. pull_request.number }}" >> $GITHUB_OUTPUT
            echo "ref=refs/pull/${{ github.event.pull_request.number }}/head" >> $GITHUB_OUTPUT
          else
            echo "pr_number=" >> $GITHUB_OUTPUT
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          fi

      - name: Debug info
        if: inputs.debug_mode == true
        run: |
          echo "Event:  ${{ github.event_name }}"
          echo "PR Number: ${{ steps.set_pr.outputs.pr_number }}"
          echo "Ref: ${{ steps.set_pr.outputs.ref }}"
          echo "Available refs for this PR:"
          git ls-remote origin | grep "pull/${{ steps.set_pr.outputs.pr_number }}" || true

      - uses: actions/checkout@v5
        with:
          ref:  ${{ steps.set_pr. outputs.ref }}
          # 获取足够的历史记录以便比较
          fetch-depth: 0

      - name: Fetch base branch
        if: steps.set_pr.outputs.pr_number != ''
        run:  |
          # 获取 base 分支
          git fetch origin ${{ github.event.pull_request.base.ref || 'main' }}

      - name: Run Codex
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: . github/codex/prompts/review.md
          output-file: codex-output.md
          safety-strategy: unsafe
          sandbox: workspace-write

      - name: Upload Codex output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name:  codex-output-pr-${{ steps.set_pr.outputs.pr_number || 'manual' }}
          path: codex-output.md
          retention-days: 7

  post_feedback:
    runs-on: ubuntu-latest
    needs: codex
    if:  needs.codex.outputs.final_message != ''
    steps:
      - name: Post Codex feedback
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const prNumber = ${{ github.event.pull_request. number || inputs.pr_number || 0 }};
            if (prNumber > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: process.env. CODEX_FINAL_MESSAGE,
              });
              console.log(`✅ Posted comment to PR #${prNumber}`);
            } else {
              console.log('ℹ️  No PR number, output below: ');
              console.log(process.env.CODEX_FINAL_MESSAGE);
            }
        env:
          CODEX_FINAL_MESSAGE: ${{ needs.codex.outputs. final_message }}
